<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>html.ai - Business Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            min-height: 100vh;
        }
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 250px;
            height: 100vh;
            background: #1e293b;
            padding: 1.5rem;
            border-right: 1px solid #334155;
        }
        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: #38bdf8;
            margin-bottom: 1rem;
        }
        .business-select {
            width: 100%;
            padding: 0.5rem;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 6px;
            color: #e2e8f0;
            margin-bottom: 1.5rem;
            font-size: 0.875rem;
        }
        .nav-item {
            display: block;
            padding: 0.75rem 1rem;
            color: #94a3b8;
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 0.25rem;
            cursor: pointer;
        }
        .nav-item:hover, .nav-item.active {
            background: #334155;
            color: #f1f5f9;
        }
        .main {
            margin-left: 250px;
            padding: 2rem;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .header h1 { font-size: 1.5rem; }
        .api-key-display {
            background: #1e293b;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.875rem;
            color: #38bdf8;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: #1e293b;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #334155;
        }
        .stat-card h3 {
            font-size: 0.875rem;
            color: #94a3b8;
            margin-bottom: 0.5rem;
        }
        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
        }
        .stat-card .value.green { color: #4ade80; }
        .stat-card .value.blue { color: #38bdf8; }
        .stat-card .value.purple { color: #a78bfa; }
        .stat-card .value.yellow { color: #fbbf24; }
        .stat-card .value.red { color: #f87171; }
        .card {
            background: #1e293b;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #334155;
            margin-bottom: 1.5rem;
        }
        .card h2 {
            font-size: 1.125rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .badge {
            background: #334155;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .badge.active { background: #166534; color: #4ade80; }
        .badge.pending { background: #854d0e; color: #fbbf24; }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            text-align: left;
            padding: 0.75rem;
            border-bottom: 1px solid #334155;
        }
        th { color: #94a3b8; font-weight: 500; font-size: 0.875rem; }
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: none;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .btn:hover { opacity: 0.9; }
        .btn-primary { background: #38bdf8; color: #0f172a; }
        .btn-success { background: #4ade80; color: #0f172a; }
        .btn-danger { background: #f87171; color: #0f172a; }
        .btn-secondary { background: #475569; color: #f1f5f9; }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #94a3b8;
            font-size: 0.875rem;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid #334155;
            background: #0f172a;
            color: #e2e8f0;
            font-size: 0.875rem;
        }
        .section { display: none; }
        .section.active { display: block; }
        .partner-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #0f172a;
            border-radius: 8px;
            margin-bottom: 0.75rem;
        }
        .partner-info h4 { margin-bottom: 0.25rem; }
        .partner-info span { color: #94a3b8; font-size: 0.875rem; }
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .alert-info { background: #1e3a5f; border: 1px solid #38bdf8; }
        .alert-success { background: #14532d; border: 1px solid #4ade80; }
        .alert-error { background: #7f1d1d; border: 1px solid #f87171; }
        .event-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .event-item {
            padding: 0.75rem;
            background: #0f172a;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        .event-item .event-name {
            color: #38bdf8;
            font-weight: 500;
        }
        .event-item .event-time {
            color: #64748b;
            font-size: 0.75rem;
        }
        .event-item .event-details {
            color: #94a3b8;
            margin-top: 0.25rem;
        }
        .refresh-btn {
            background: transparent;
            border: 1px solid #334155;
            color: #94a3b8;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
        }
        .refresh-btn:hover {
            background: #334155;
            color: #f1f5f9;
        }
        .loading {
            color: #64748b;
            font-style: italic;
        }
        .cross-site-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #4ade80;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
    </style>
</head>
<body>
    <nav class="sidebar">
        <div class="logo">html.ai</div>
        <select class="business-select" id="business-select" onchange="switchBusiness()">
            <option value="pk_demo_shoes_123">ShoeMax (Business A)</option>
            <option value="pk_demo_clothes_456">StyleHub (Business B)</option>
            <option value="pk_demo_test123">Demo Store</option>
        </select>
        <a class="nav-item active" onclick="showSection('overview')">Overview</a>
        <a class="nav-item" onclick="showSection('events')">Live Events</a>
        <a class="nav-item" onclick="showSection('users')">Users</a>
        <a class="nav-item" onclick="showSection('scoring')">Scoring</a>
        <a class="nav-item" onclick="showSection('cross-site')">Cross-Site</a>
        <a class="nav-item" onclick="showSection('partners')">Data Partners</a>
        <a class="nav-item" onclick="showSection('settings')">Settings</a>
    </nav>

    <main class="main">
        <!-- Overview Section -->
        <section id="overview" class="section active">
            <div class="header">
                <h1>Dashboard Overview</h1>
                <button class="refresh-btn" onclick="loadDashboard()">Refresh</button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Events</h3>
                    <div class="value blue" id="stat-events">-</div>
                </div>
                <div class="stat-card">
                    <h3>Unique Users</h3>
                    <div class="value green" id="stat-users">-</div>
                </div>
                <div class="stat-card">
                    <h3>Conversion Rate</h3>
                    <div class="value purple" id="stat-conversion">-</div>
                </div>
                <div class="stat-card">
                    <h3>Cross-Site Users</h3>
                    <div class="value yellow" id="stat-crosssite">-</div>
                </div>
                <div class="stat-card">
                    <h3>Events This Month</h3>
                    <div class="value red" id="stat-monthly">-</div>
                </div>
            </div>

            <div class="card">
                <h2>Variant Performance</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Variant</th>
                            <th>Identity State</th>
                            <th>Shown</th>
                            <th>Conversions</th>
                            <th>Rate</th>
                        </tr>
                    </thead>
                    <tbody id="variant-table">
                        <tr><td colspan="5" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="card">
                <h2>Recent Activity</h2>
                <div id="recent-events" class="event-list">
                    <p class="loading">Loading...</p>
                </div>
            </div>
        </section>

        <!-- Live Events Section -->
        <section id="events" class="section">
            <div class="header">
                <h1>Live Events</h1>
                <button class="refresh-btn" onclick="loadEvents()">Refresh</button>
            </div>

            <div class="card">
                <h2>Event Stream</h2>
                <div id="event-stream" class="event-list">
                    <p class="loading">Loading events...</p>
                </div>
            </div>
        </section>

        <!-- Users Section -->
        <section id="users" class="section">
            <div class="header">
                <h1>Users</h1>
                <button class="refresh-btn" onclick="loadUsers()">Refresh</button>
            </div>

            <div class="card">
                <h2>Search User</h2>
                <div class="form-group">
                    <label>User ID</label>
                    <input type="text" id="search-user-id" placeholder="user_xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">
                </div>
                <button class="btn btn-primary" onclick="searchUser()">Search</button>
            </div>

            <div class="card">
                <h2>User Journey</h2>
                <div id="user-journey-result">
                    <p style="color:#64748b;">Enter a user ID above to view their journey</p>
                </div>
            </div>
        </section>

        <!-- Scoring Section -->
        <section id="scoring" class="section">
            <div class="header">
                <h1>Scoring Settings</h1>
                <button class="refresh-btn" onclick="loadScoring()">Refresh</button>
            </div>

            <div class="alert alert-info">
                Adjust the weight multipliers for each interaction type. Higher weights mean more impact on variant scores.
                When the score difference between variants exceeds the threshold, the losing variant is regenerated.
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Score Threshold</h3>
                    <div class="value yellow" id="stat-threshold">5.0</div>
                </div>
                <div class="stat-card">
                    <h3>Active Components</h3>
                    <div class="value blue" id="stat-components">-</div>
                </div>
                <div class="stat-card">
                    <h3>Total Regenerations</h3>
                    <div class="value green" id="stat-regenerations">-</div>
                </div>
            </div>

            <div class="card">
                <h2>Threshold Settings</h2>
                <div class="form-group">
                    <label>Regeneration Threshold <span id="threshold-value-display" style="color:#38bdf8;">(5.0)</span></label>
                    <input type="range" id="threshold-slider" min="1" max="20" step="0.5" value="5"
                           style="width:100%;accent-color:#38bdf8;" onchange="updateThresholdDisplay()">
                    <p style="color:#64748b;font-size:0.75rem;margin-top:0.25rem;">
                        When score difference exceeds this value, the losing variant is regenerated
                    </p>
                </div>
            </div>

            <div class="card">
                <h2>Positive Interaction Weights <span class="badge active">Increase Score</span></h2>
                <div style="display:grid;gap:1rem;margin-top:1rem;">
                    <div class="weight-slider" data-weight="click">
                        <label>Click <span class="weight-value" style="color:#4ade80;">(1.0)</span></label>
                        <input type="range" min="0" max="10" step="0.5" value="1" style="width:100%;accent-color:#4ade80;">
                        <p style="color:#64748b;font-size:0.75rem;">Basic click on any element</p>
                    </div>
                    <div class="weight-slider" data-weight="cta_click">
                        <label>CTA Click <span class="weight-value" style="color:#4ade80;">(3.0)</span></label>
                        <input type="range" min="0" max="10" step="0.5" value="3" style="width:100%;accent-color:#4ade80;">
                        <p style="color:#64748b;font-size:0.75rem;">Call-to-action button clicks (high value)</p>
                    </div>
                    <div class="weight-slider" data-weight="add_to_cart">
                        <label>Add to Cart <span class="weight-value" style="color:#4ade80;">(5.0)</span></label>
                        <input type="range" min="0" max="15" step="0.5" value="5" style="width:100%;accent-color:#4ade80;">
                        <p style="color:#64748b;font-size:0.75rem;">Strong purchase intent signal</p>
                    </div>
                    <div class="weight-slider" data-weight="purchase">
                        <label>Purchase <span class="weight-value" style="color:#4ade80;">(10.0)</span></label>
                        <input type="range" min="0" max="20" step="0.5" value="10" style="width:100%;accent-color:#4ade80;">
                        <p style="color:#64748b;font-size:0.75rem;">Conversion - highest value action</p>
                    </div>
                    <div class="weight-slider" data-weight="form_submit">
                        <label>Form Submit <span class="weight-value" style="color:#4ade80;">(4.0)</span></label>
                        <input type="range" min="0" max="10" step="0.5" value="4" style="width:100%;accent-color:#4ade80;">
                        <p style="color:#64748b;font-size:0.75rem;">Form submission (leads, signup forms)</p>
                    </div>
                    <div class="weight-slider" data-weight="signup">
                        <label>Signup <span class="weight-value" style="color:#4ade80;">(6.0)</span></label>
                        <input type="range" min="0" max="15" step="0.5" value="6" style="width:100%;accent-color:#4ade80;">
                        <p style="color:#64748b;font-size:0.75rem;">User registration</p>
                    </div>
                    <div class="weight-slider" data-weight="share">
                        <label>Share <span class="weight-value" style="color:#4ade80;">(2.0)</span></label>
                        <input type="range" min="0" max="10" step="0.5" value="2" style="width:100%;accent-color:#4ade80;">
                        <p style="color:#64748b;font-size:0.75rem;">Social share actions</p>
                    </div>
                    <div class="weight-slider" data-weight="hover_long">
                        <label>Long Hover <span class="weight-value" style="color:#4ade80;">(0.5)</span></label>
                        <input type="range" min="0" max="5" step="0.1" value="0.5" style="width:100%;accent-color:#4ade80;">
                        <p style="color:#64748b;font-size:0.75rem;">Hover &gt; 2 seconds - engagement signal</p>
                    </div>
                    <div class="weight-slider" data-weight="video_complete">
                        <label>Video Complete <span class="weight-value" style="color:#4ade80;">(3.0)</span></label>
                        <input type="range" min="0" max="10" step="0.5" value="3" style="width:100%;accent-color:#4ade80;">
                        <p style="color:#64748b;font-size:0.75rem;">Watched video to completion</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Negative Interaction Weights <span class="badge" style="background:#7f1d1d;color:#f87171;">Decrease Score</span></h2>
                <div style="display:grid;gap:1rem;margin-top:1rem;">
                    <div class="weight-slider" data-weight="bounce">
                        <label>Bounce <span class="weight-value" style="color:#f87171;">(-2.0)</span></label>
                        <input type="range" min="-10" max="0" step="0.5" value="-2" style="width:100%;accent-color:#f87171;">
                        <p style="color:#64748b;font-size:0.75rem;">User left quickly</p>
                    </div>
                    <div class="weight-slider" data-weight="rage_click">
                        <label>Rage Click <span class="weight-value" style="color:#f87171;">(-1.5)</span></label>
                        <input type="range" min="-10" max="0" step="0.5" value="-1.5" style="width:100%;accent-color:#f87171;">
                        <p style="color:#64748b;font-size:0.75rem;">Frustration signal - rapid repeated clicks</p>
                    </div>
                    <div class="weight-slider" data-weight="dead_click">
                        <label>Dead Click <span class="weight-value" style="color:#f87171;">(-0.5)</span></label>
                        <input type="range" min="-5" max="0" step="0.1" value="-0.5" style="width:100%;accent-color:#f87171;">
                        <p style="color:#64748b;font-size:0.75rem;">Click on non-interactive element</p>
                    </div>
                    <div class="weight-slider" data-weight="scroll_fast">
                        <label>Fast Scroll <span class="weight-value" style="color:#f87171;">(-0.3)</span></label>
                        <input type="range" min="-5" max="0" step="0.1" value="-0.3" style="width:100%;accent-color:#f87171;">
                        <p style="color:#64748b;font-size:0.75rem;">Skimming content, not engaged</p>
                    </div>
                    <div class="weight-slider" data-weight="exit_intent">
                        <label>Exit Intent <span class="weight-value" style="color:#f87171;">(-1.0)</span></label>
                        <input type="range" min="-5" max="0" step="0.5" value="-1" style="width:100%;accent-color:#f87171;">
                        <p style="color:#64748b;font-size:0.75rem;">Mouse moved to close tab</p>
                    </div>
                    <div class="weight-slider" data-weight="tab_switch">
                        <label>Tab Switch <span class="weight-value" style="color:#f87171;">(-0.2)</span></label>
                        <input type="range" min="-5" max="0" step="0.1" value="-0.2" style="width:100%;accent-color:#f87171;">
                        <p style="color:#64748b;font-size:0.75rem;">Lost attention to another tab</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Component Leaderboard</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Component ID</th>
                            <th>Variant A Score</th>
                            <th>Variant B Score</th>
                            <th>Winner</th>
                            <th>Regenerations</th>
                        </tr>
                    </thead>
                    <tbody id="component-leaderboard">
                        <tr><td colspan="5" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>

            <div style="display:flex;gap:1rem;margin-top:1.5rem;">
                <button class="btn btn-success" onclick="saveWeights()">Save All Weights</button>
                <button class="btn btn-secondary" onclick="resetWeights()">Reset to Defaults</button>
            </div>
        </section>

        <!-- Cross-Site Section -->
        <section id="cross-site" class="section">
            <div class="header">
                <h1>Cross-Site Tracking</h1>
                <button class="refresh-btn" onclick="loadCrossSite()">Refresh</button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Global Users Linked</h3>
                    <div class="value green" id="global-users-count">-</div>
                </div>
                <div class="stat-card">
                    <h3>Partner Businesses</h3>
                    <div class="value blue" id="partner-count">-</div>
                </div>
            </div>

            <div class="card">
                <h2>Cross-Site User Journeys</h2>
                <div id="cross-site-journeys">
                    <p class="loading">Loading cross-site data...</p>
                </div>
            </div>

            <div class="card">
                <h2>Global User Lookup</h2>
                <div class="form-group">
                    <label>Global UID</label>
                    <input type="text" id="global-uid-search" placeholder="guid_xxxxxxxxxx">
                </div>
                <button class="btn btn-primary" onclick="lookupGlobalUser()">Lookup</button>
                <div id="global-user-result" style="margin-top:1rem;"></div>
            </div>
        </section>

        <!-- Partners Section -->
        <section id="partners" class="section">
            <div class="header">
                <h1>Data Partners</h1>
                <button class="btn btn-primary" onclick="showAddPartner()">+ Add Partner</button>
            </div>

            <div class="card" id="add-partner-form" style="display:none;">
                <h2>Request Data Sharing</h2>
                <div class="form-group">
                    <label>Partner Business ID</label>
                    <input type="text" id="partner-business-id" placeholder="biz_xxxxx">
                </div>
                <div class="form-group">
                    <label>Sharing Level</label>
                    <select id="sharing-level">
                        <option value="aggregate">Aggregate (Behavioral profiles only)</option>
                        <option value="full">Full (Complete user journeys)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="share-conversions"> Share conversion data
                    </label>
                </div>
                <button class="btn btn-success" onclick="requestPartnership()">Send Request</button>
                <button class="btn btn-secondary" onclick="hideAddPartner()">Cancel</button>
            </div>

            <div class="card">
                <h2>Active Partners</h2>
                <div id="active-partners">
                    <p class="loading">Loading...</p>
                </div>
            </div>

            <div class="card">
                <h2>Pending Requests</h2>
                <div id="pending-requests">
                    <p class="loading">Loading...</p>
                </div>
            </div>
        </section>

        <!-- Settings Section -->
        <section id="settings" class="section">
            <div class="header">
                <h1>Settings</h1>
            </div>

            <div class="card">
                <h2>Current Business</h2>
                <div id="business-info">
                    <p class="loading">Loading...</p>
                </div>
            </div>

            <div class="card">
                <h2>API Credentials</h2>
                <div class="form-group">
                    <label>Public API Key</label>
                    <input type="text" id="display-api-key" readonly>
                </div>
                <p style="color:#64748b;font-size:0.875rem;margin-top:0.5rem;">
                    Use this key in your SDK integration. It's safe to expose in frontend code.
                </p>
            </div>
        </section>
    </main>

    <script>
        const API_URL = 'http://localhost:3000';
        let currentApiKey = 'pk_demo_shoes_123';

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('display-api-key').value = currentApiKey;
            loadDashboard();
        });

        function switchBusiness() {
            currentApiKey = document.getElementById('business-select').value;
            document.getElementById('display-api-key').value = currentApiKey;
            loadDashboard();
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');

            // Load section data
            if (sectionId === 'overview') loadDashboard();
            if (sectionId === 'events') loadEvents();
            if (sectionId === 'users') loadUsers();
            if (sectionId === 'scoring') loadScoring();
            if (sectionId === 'cross-site') loadCrossSite();
            if (sectionId === 'partners') loadPartners();
            if (sectionId === 'settings') loadSettings();
        }

        async function loadDashboard() {
            try {
                // Fetch dashboard stats
                const res = await fetch(`${API_URL}/api/analytics/dashboard`, {
                    headers: { 'X-API-Key': currentApiKey }
                });

                if (!res.ok) {
                    throw new Error(`API error: ${res.status}`);
                }

                const data = await res.json();
                console.log('Dashboard data:', data);

                document.getElementById('stat-events').textContent = data.total_events || 0;
                document.getElementById('stat-users').textContent = data.total_users || 0;

                // Calculate conversion rate
                let totalShown = 0, totalConv = 0;
                if (data.variant_performance && data.variant_performance.length > 0) {
                    data.variant_performance.forEach(v => {
                        totalShown += v.total_shown || 0;
                        totalConv += v.conversions || 0;
                    });
                }
                const convRate = totalShown > 0 ? ((totalConv / totalShown) * 100).toFixed(1) : '0';
                document.getElementById('stat-conversion').textContent = convRate + '%';

                // Render variant table
                const tbody = document.getElementById('variant-table');
                if (data.variant_performance && data.variant_performance.length > 0) {
                    tbody.innerHTML = data.variant_performance.map(v => `
                        <tr>
                            <td>${v._id?.variant_id || 'N/A'}</td>
                            <td><span class="badge">${v._id?.identity_state || 'N/A'}</span></td>
                            <td>${v.total_shown || 0}</td>
                            <td>${v.conversions || 0}</td>
                            <td>${((v.conversion_rate || 0) * 100).toFixed(1)}%</td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" style="color:#64748b;">No variant data yet. Browse the demo stores to generate data.</td></tr>';
                }

                // Load recent events for overview
                loadRecentEvents();

                // Try to get business info for monthly usage
                try {
                    const bizRes = await fetch(`${API_URL}/api/business/me`, {
                        headers: { 'X-API-Key': currentApiKey }
                    });
                    if (bizRes.ok) {
                        const bizData = await bizRes.json();
                        document.getElementById('stat-monthly').textContent = bizData.usage?.events_used || 0;
                        document.getElementById('stat-crosssite').textContent = bizData.usage?.partners_count || 0;
                    }
                } catch (e) {
                    console.log('Could not fetch business info');
                }

            } catch (err) {
                console.error('Failed to load dashboard:', err);
                document.getElementById('stat-events').textContent = 'Error';
            }
        }

        async function loadRecentEvents() {
            const container = document.getElementById('recent-events');
            try {
                // Get a sample user to show events
                const res = await fetch(`${API_URL}/api/analytics/dashboard`, {
                    headers: { 'X-API-Key': currentApiKey }
                });
                const data = await res.json();

                if (data.total_events > 0) {
                    container.innerHTML = `
                        <div class="alert alert-info">
                            <strong>${data.total_events}</strong> events tracked across <strong>${data.total_users}</strong> users.
                            <br><br>
                            Use the "Live Events" tab or "Users" tab to explore detailed event data.
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="alert alert-info">
                            No events recorded yet. Visit the demo stores to generate tracking data:
                            <br><br>
                            <a href="http://localhost:8082/demo-business-a.html" target="_blank" style="color:#38bdf8;">Business A (ShoeMax)</a> |
                            <a href="http://localhost:8082/demo-business-b.html" target="_blank" style="color:#38bdf8;">Business B (StyleHub)</a>
                        </div>
                    `;
                }
            } catch (err) {
                container.innerHTML = '<p style="color:#f87171;">Failed to load events</p>';
            }
        }

        async function loadEvents() {
            const container = document.getElementById('event-stream');
            container.innerHTML = '<p class="loading">Loading events...</p>';

            try {
                const res = await fetch(`${API_URL}/api/analytics/dashboard`, {
                    headers: { 'X-API-Key': currentApiKey }
                });
                const data = await res.json();

                if (data.total_events > 0) {
                    container.innerHTML = `
                        <div class="alert alert-info">
                            <strong>${data.total_events}</strong> total events recorded.
                            <br><br>
                            To see individual events, search for a specific user in the Users tab.
                        </div>
                    `;
                } else {
                    container.innerHTML = '<p style="color:#64748b;">No events yet. Browse the demo stores to generate events.</p>';
                }
            } catch (err) {
                container.innerHTML = '<p style="color:#f87171;">Failed to load events</p>';
            }
        }

        async function loadUsers() {
            // Users section is search-based, no auto-load needed
        }

        async function searchUser() {
            const userId = document.getElementById('search-user-id').value.trim();
            const resultDiv = document.getElementById('user-journey-result');

            if (!userId) {
                resultDiv.innerHTML = '<p style="color:#f87171;">Please enter a user ID</p>';
                return;
            }

            resultDiv.innerHTML = '<p class="loading">Searching...</p>';

            try {
                const res = await fetch(`${API_URL}/api/user/${encodeURIComponent(userId)}/journey`, {
                    headers: { 'X-API-Key': currentApiKey }
                });

                if (!res.ok) {
                    throw new Error('User not found');
                }

                const data = await res.json();

                resultDiv.innerHTML = `
                    <div style="background:#0f172a;padding:1rem;border-radius:8px;">
                        <p><strong>User ID:</strong> ${data.user_id}</p>
                        <p><strong>Session:</strong> ${data.session?.session_id || 'N/A'}</p>
                        <p><strong>Identity State:</strong> <span class="badge">${data.session?.identity_state || 'Unknown'}</span></p>
                        <p><strong>Total Events:</strong> ${data.events?.length || 0}</p>

                        ${data.events && data.events.length > 0 ? `
                            <h4 style="margin-top:1rem;margin-bottom:0.5rem;">Events:</h4>
                            <div class="event-list" style="max-height:300px;">
                                ${data.events.map(e => `
                                    <div class="event-item">
                                        <span class="event-name">${e.event_name}</span>
                                        <span class="event-time">${e.timestamp || ''}</span>
                                        ${e.component_id ? `<div class="event-details">Component: ${e.component_id}</div>` : ''}
                                        ${e.global_uid ? `<div class="event-details"><span class="cross-site-indicator"></span>Global UID: ${e.global_uid}</div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p style="margin-top:1rem;color:#64748b;">No events recorded</p>'}
                    </div>
                `;
            } catch (err) {
                resultDiv.innerHTML = `<p style="color:#f87171;">User not found or error: ${err.message}</p>`;
            }
        }

        async function loadCrossSite() {
            try {
                const res = await fetch(`${API_URL}/api/analytics/cross-site`, {
                    headers: { 'X-API-Key': currentApiKey }
                });

                if (!res.ok) {
                    throw new Error('Failed to load');
                }

                const data = await res.json();

                document.getElementById('global-users-count').textContent = data.cross_site_users || 0;
                document.getElementById('partner-count').textContent = data.partner_count || 0;

                const container = document.getElementById('cross-site-journeys');
                if (data.cross_site_users > 0) {
                    container.innerHTML = `
                        <div class="alert alert-success">
                            <strong>${data.cross_site_users}</strong> users have been tracked across multiple partner sites!
                        </div>
                        ${data.sample_journeys ? `
                            <div style="margin-top:1rem;">
                                <h4>Sample Cross-Site Users:</h4>
                                ${data.sample_journeys.slice(0, 5).map(j => `
                                    <div class="event-item">
                                        <span class="cross-site-indicator"></span>
                                        <strong>${j._id}</strong> - ${j.total_events} events across ${j.businesses?.length || 0} sites
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    `;
                } else {
                    container.innerHTML = `
                        <div class="alert alert-info">
                            No cross-site users detected yet.
                            <br><br>
                            To test cross-site tracking:
                            <ol style="margin-top:0.5rem;margin-left:1rem;">
                                <li>Visit <a href="http://localhost:8082/demo-business-a.html" target="_blank" style="color:#38bdf8;">Business A</a></li>
                                <li>Click around and interact</li>
                                <li>Visit <a href="http://localhost:8082/demo-business-b.html" target="_blank" style="color:#38bdf8;">Business B</a></li>
                                <li>You should see the "CROSS-SITE" indicator</li>
                            </ol>
                        </div>
                    `;
                }
            } catch (err) {
                document.getElementById('cross-site-journeys').innerHTML = '<p style="color:#f87171;">Failed to load cross-site data</p>';
            }
        }

        async function lookupGlobalUser() {
            const guid = document.getElementById('global-uid-search').value.trim();
            const resultDiv = document.getElementById('global-user-result');

            if (!guid) {
                resultDiv.innerHTML = '<p style="color:#f87171;">Please enter a Global UID</p>';
                return;
            }

            resultDiv.innerHTML = '<p class="loading">Looking up...</p>';

            // For now, just show the GUID - in production this would query the global_users collection
            resultDiv.innerHTML = `
                <div style="background:#0f172a;padding:1rem;border-radius:8px;">
                    <p><strong>Global UID:</strong> ${guid}</p>
                    <p style="color:#64748b;margin-top:0.5rem;">
                        Global user lookup requires server-side implementation.
                        The user is tracked via this GUID across all partner businesses.
                    </p>
                </div>
            `;
        }

        async function loadPartners() {
            try {
                // Get business info to see partners
                const bizRes = await fetch(`${API_URL}/api/business/me`, {
                    headers: { 'X-API-Key': currentApiKey }
                });

                if (bizRes.ok) {
                    const bizData = await bizRes.json();
                    const activeContainer = document.getElementById('active-partners');

                    if (bizData.usage?.partners_count > 0) {
                        activeContainer.innerHTML = `
                            <div class="alert alert-success">
                                Connected to ${bizData.usage.partners_count} partner(s)
                            </div>
                        `;
                    } else {
                        activeContainer.innerHTML = '<p style="color:#64748b;">No active partners</p>';
                    }
                }

                // Get pending requests
                const pendingRes = await fetch(`${API_URL}/api/sharing/pending`, {
                    headers: { 'X-API-Key': currentApiKey }
                });

                const pendingContainer = document.getElementById('pending-requests');
                if (pendingRes.ok) {
                    const pendingData = await pendingRes.json();

                    if (pendingData.incoming && pendingData.incoming.length > 0) {
                        pendingContainer.innerHTML = pendingData.incoming.map(a => `
                            <div class="partner-card">
                                <div class="partner-info">
                                    <h4>From: ${a.from_business_id}</h4>
                                    <span>Level: ${a.sharing_level}</span>
                                </div>
                                <div>
                                    <button class="btn btn-success" onclick="acceptPartner('${a.agreement_id}')">Accept</button>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        pendingContainer.innerHTML = '<p style="color:#64748b;">No pending requests</p>';
                    }
                } else {
                    pendingContainer.innerHTML = '<p style="color:#64748b;">No pending requests</p>';
                }
            } catch (err) {
                console.error('Failed to load partners:', err);
            }
        }

        async function loadSettings() {
            try {
                const res = await fetch(`${API_URL}/api/business/me`, {
                    headers: { 'X-API-Key': currentApiKey }
                });

                const container = document.getElementById('business-info');
                if (res.ok) {
                    const data = await res.json();
                    container.innerHTML = `
                        <div style="display:grid;gap:0.5rem;">
                            <p><strong>Business ID:</strong> ${data.business_id}</p>
                            <p><strong>Name:</strong> ${data.name}</p>
                            <p><strong>Domain:</strong> ${data.domain}</p>
                            <p><strong>Tier:</strong> <span class="badge active">${data.tier}</span></p>
                            <p><strong>Events Used:</strong> ${data.usage?.events_used || 0} / ${data.usage?.events_limit || 'unlimited'}</p>
                            <p><strong>Cross-Site Tracking:</strong> ${data.features?.cross_site_tracking ? 'Enabled' : 'Disabled'}</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = '<p style="color:#f87171;">Could not load business info</p>';
                }
            } catch (err) {
                document.getElementById('business-info').innerHTML = '<p style="color:#f87171;">Error loading settings</p>';
            }
        }

        function showAddPartner() {
            document.getElementById('add-partner-form').style.display = 'block';
        }

        function hideAddPartner() {
            document.getElementById('add-partner-form').style.display = 'none';
        }

        async function requestPartnership() {
            const partnerId = document.getElementById('partner-business-id').value;
            const level = document.getElementById('sharing-level').value;
            const shareConversions = document.getElementById('share-conversions').checked;

            try {
                const res = await fetch(`${API_URL}/api/sharing/request`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': currentApiKey
                    },
                    body: JSON.stringify({
                        partner_business_id: partnerId,
                        sharing_level: level,
                        permissions: { share_conversion_data: shareConversions }
                    })
                });
                const data = await res.json();
                alert(data.message || 'Request sent!');
                hideAddPartner();
                loadPartners();
            } catch (err) {
                alert('Failed to send request');
            }
        }

        async function acceptPartner(agreementId) {
            try {
                await fetch(`${API_URL}/api/sharing/accept/${agreementId}`, {
                    method: 'POST',
                    headers: { 'X-API-Key': currentApiKey }
                });
                alert('Partnership activated!');
                loadPartners();
            } catch (err) {
                alert('Failed to accept');
            }
        }

        // ========================================
        // Scoring Section Functions
        // ========================================

        // Default weights from the scoring model
        const DEFAULT_WEIGHTS = {
            click: 1.0,
            cta_click: 3.0,
            add_to_cart: 5.0,
            purchase: 10.0,
            form_submit: 4.0,
            signup: 6.0,
            share: 2.0,
            save: 2.5,
            hover_long: 0.5,
            scroll_to_bottom: 1.5,
            video_play: 1.0,
            video_complete: 3.0,
            bounce: -2.0,
            rage_click: -1.5,
            dead_click: -0.5,
            scroll_fast: -0.3,
            exit_intent: -1.0,
            tab_switch: -0.2,
            page_view: 0.1,
            component_view: 0.2,
            scroll: 0.05,
            mouse_move: 0.0
        };

        let currentWeights = { ...DEFAULT_WEIGHTS };
        let currentThreshold = 5.0;

        function updateThresholdDisplay() {
            const slider = document.getElementById('threshold-slider');
            const display = document.getElementById('threshold-value-display');
            display.textContent = `(${parseFloat(slider.value).toFixed(1)})`;
            currentThreshold = parseFloat(slider.value);
        }

        async function loadScoring() {
            // Load current weights from server
            try {
                const res = await fetch(`${API_URL}/api/scoring/weights`, {
                    headers: { 'X-API-Key': currentApiKey }
                });

                if (res.ok) {
                    const data = await res.json();
                    if (data.weights) {
                        currentWeights = { ...DEFAULT_WEIGHTS, ...data.weights };
                    }
                    if (data.score_threshold) {
                        currentThreshold = data.score_threshold;
                        document.getElementById('threshold-slider').value = currentThreshold;
                        document.getElementById('threshold-value-display').textContent = `(${currentThreshold.toFixed(1)})`;
                        document.getElementById('stat-threshold').textContent = currentThreshold.toFixed(1);
                    }
                }
            } catch (err) {
                console.log('Could not load weights, using defaults');
            }

            // Update all sliders with current values
            document.querySelectorAll('.weight-slider').forEach(slider => {
                const weightName = slider.dataset.weight;
                const input = slider.querySelector('input[type="range"]');
                const valueDisplay = slider.querySelector('.weight-value');

                if (currentWeights[weightName] !== undefined) {
                    input.value = currentWeights[weightName];
                    const val = currentWeights[weightName];
                    valueDisplay.textContent = `(${val >= 0 ? val.toFixed(1) : val.toFixed(1)})`;
                }

                // Add change listener
                input.addEventListener('input', function() {
                    const val = parseFloat(this.value);
                    valueDisplay.textContent = `(${val >= 0 ? val.toFixed(1) : val.toFixed(1)})`;
                    currentWeights[weightName] = val;
                });
            });

            // Load component leaderboard
            loadComponentLeaderboard();
        }

        async function loadComponentLeaderboard() {
            const tbody = document.getElementById('component-leaderboard');

            try {
                const res = await fetch(`${API_URL}/api/scoring/leaderboard?limit=10`, {
                    headers: { 'X-API-Key': currentApiKey }
                });

                if (!res.ok) throw new Error('Failed to load');

                const data = await res.json();

                if (data.leaderboard && data.leaderboard.length > 0) {
                    let totalRegens = 0;
                    tbody.innerHTML = data.leaderboard.map(item => {
                        const scoreA = item.variant_a?.current_score || 0;
                        const scoreB = item.variant_b?.current_score || 0;
                        const winner = scoreA > scoreB ? 'A' : (scoreB > scoreA ? 'B' : 'Tie');
                        const regens = item.regeneration_count || 0;
                        totalRegens += regens;

                        return `
                            <tr>
                                <td>${item.component_id}</td>
                                <td style="color:#667eea;">${scoreA.toFixed(2)}</td>
                                <td style="color:#e74c3c;">${scoreB.toFixed(2)}</td>
                                <td><span class="badge ${winner === 'A' ? 'active' : (winner === 'B' ? '' : 'pending')}">${winner}</span></td>
                                <td>${regens}</td>
                            </tr>
                        `;
                    }).join('');

                    document.getElementById('stat-components').textContent = data.leaderboard.length;
                    document.getElementById('stat-regenerations').textContent = totalRegens;
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" style="color:#64748b;">No scoring data yet. Interact with the demo stores to generate scores.</td></tr>';
                    document.getElementById('stat-components').textContent = '0';
                    document.getElementById('stat-regenerations').textContent = '0';
                }
            } catch (err) {
                console.error('Failed to load leaderboard:', err);
                tbody.innerHTML = '<tr><td colspan="5" style="color:#f87171;">Failed to load leaderboard</td></tr>';
            }
        }

        async function saveWeights() {
            try {
                const res = await fetch(`${API_URL}/api/scoring/weights`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': currentApiKey
                    },
                    body: JSON.stringify({
                        weights: currentWeights,
                        score_threshold: currentThreshold
                    })
                });

                if (res.ok) {
                    alert('Weights saved successfully!');
                } else {
                    throw new Error('Failed to save');
                }
            } catch (err) {
                alert('Failed to save weights: ' + err.message);
            }
        }

        function resetWeights() {
            if (!confirm('Reset all weights to default values?')) return;

            currentWeights = { ...DEFAULT_WEIGHTS };
            currentThreshold = 5.0;

            // Update threshold
            document.getElementById('threshold-slider').value = 5.0;
            document.getElementById('threshold-value-display').textContent = '(5.0)';

            // Update all sliders
            document.querySelectorAll('.weight-slider').forEach(slider => {
                const weightName = slider.dataset.weight;
                const input = slider.querySelector('input[type="range"]');
                const valueDisplay = slider.querySelector('.weight-value');

                if (DEFAULT_WEIGHTS[weightName] !== undefined) {
                    input.value = DEFAULT_WEIGHTS[weightName];
                    const val = DEFAULT_WEIGHTS[weightName];
                    valueDisplay.textContent = `(${val >= 0 ? val.toFixed(1) : val.toFixed(1)})`;
                }
            });

            // Save reset weights
            saveWeights();
        }
    </script>
</body>
</html>
